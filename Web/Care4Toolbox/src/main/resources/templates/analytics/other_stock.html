<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/layout1}">

<!-- 사용자 CSS 추가 -->
<th:block layout:fragment="css">
	<style>
		.td_btn,
		.th_btn {
			text-align: end;
		}

		.selectable:hover {
			box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
		}
	</style>
</th:block>
<!-- Main Content -->
<div class="main-content" layout:fragment="content">
	<div class="container-fluid" style="height:100%;">
		<div class="row">
			<!-- Contact Header -->
			<div class="col-12">
				<div class="card d-flex  flex-column flex-md-row  bg-white mb-30 p-3 align-items-center text-align-left">
					<h4 class="font-30 m-3" style="width:100%;">타 공구실 재고 조회</h4>
					<div class="custom-select style--two large m-3">
						<select class="theme-input-style" id="toolboxSelect">
							<option th:each="toolbox : ${toolboxList}" th:value="${toolbox.id}"
												th:text="${toolbox.name}">name?</option>
						</select>
					</div>
					<!-- Search Form -->
					<form class="search-form m-4" style="width:100%; box-sizing: content-box;">
						<div class="theme-input-group style--two">
							<input id="searchInput" type="text" class="theme-input-style"
								placeholder="검색" />
							<button id="searchBtn" type="submit">
								<img th:src="@{/img/svg/search-icon.svg}" alt="" class="svg" />
							</button>
						</div>
					</form>
					<!-- End Search Form -->
				</div>
			</div>
			<!-- Right Tool Div -->
			<div class="col-12">
				<!-- Card -->
				<div class="card bg-transparent" style="height:100%;">
					<div class="table-responsive" style="height:100%;">
						<!-- Invoice List Table -->
						<table id="datatable" class="text-nowrap bg-white invoice-list-table" style="height:100%;">
							<thead>
								<tr>
									<th>
										Id
									</th>
									<th>
										이름
									</th>
									<th>
										영문이름
									</th>
									<th>
										품목번호
									</th>
									<th>
										대분류
									</th>
									<th>
										중분류
									</th>
									<th>
										스펙
									</th>
									<th>
										단위
									</th>
									<th>
										가격
									</th>
									<th>
										교체주기
									</th>
									<th>
										재고
									</th>
									<th>추가</th>
								</tr>
							</thead>
							<tbody style="height:100%;">

							</tbody>
						</table>
						<!-- End Contact List Table -->
					</div>


				</div>
				<!-- End Card -->
			</div>
		</div>
	</div>
</div>
<!-- End Main Content -->
<!-- 사용자 script 추가 -->
<th:block layout:fragment="script">
	<script th:inline="javascript">
		//datatable 초기화 전 전역 선언.
		var table = {draw: function () {console.log('not initialized yet')}};
		var membershipId=1;
		var toolboxId = 5222;
		$(document).ready(function () {
			
			abcHttp.get(
				'/membership/getbycode',
				{
					code:parseInt( document.getElementById("user-code").textContent)
				}
			)
			.then(data=>{
				membershpId = data.id;
				
				abcHttp.get(
					'/toolbox/getbyname',
					{
						name:data.partDto.subPartDto.mainPartDto.name
					}
				)
				.then(toolboxData=>{
					if (toolboxData==null){
						return;
					}
					toolboxId=toolboxData.id;
				});
			});
			
			// =============== ▼ table ===============
			var csrfToken = document.querySelector('meta[name="_csrf"]').content;
			
			table = $('#datatable').DataTable({
				"paging": true,          // 페이지네이션 사용
				"pageLength": 10, 		// 페이지당 항목 수
				"lengthChange": false,   // 페이지 크기 변경 기능 비활성화
				"searching": false,       // 검색 기능 사용
				"ordering": false,        // 정렬 기능 사용
				"order": [
					[0, 'asc']
				],
				"info": true,            // 정보 표시
				"autoWidth": false,      // 너비 자동 조정 비활성화
				"serverSide": true,
				"processing": true,
				"ajax": {
					"url": `/stock_status/getpage`, // 데이터를 가져올 엔드포인트 URL
					//"dataSrc": "content",   // JSON 응답에서 실제 데이터가 포함된 위치
					"method": "POST",
					"contentType": "application/json",
					"headers":{
						'X-CSRF-Token': csrfToken,
					},
					"data": function (d) {
						var data = {
							"page": parseInt(d.start / d.length),
							"size": d.length,
							"name": $("#searchInput").val(),
							"toolboxId": $("#toolboxSelect").val(),
							"subGroupId": [],
							//"order": columnsDefine[d.order[0].column].column,
							//"search": 'tagid',
							//"direction": d.order[0].dir.toUpperCase(),
							//"keyword": d.search.value
						};
						return JSON.stringify(data);
					},
					"dataFilter": function (data) {
						data.dataSrc = "content";
						data = JSON.parse(data);
						var json = {
							recordsTotal: data.totalElements,
							recordsFiltered: data.totalElements,
							data: data.content
						};
						return JSON.stringify(json)
					}
				},
				"columnDefs": [
					{
						"targets": [0, 2, 5, 7, 8, 9],
						"visible": false
					}
				],
				"columns": [
					/*{
						"data": null,
						"render": function() {
							// 제품 정보 표시
							return '<label class="custom-checkbox">'+
									'<input type="checkbox" />'+
									'<span class="checkmark"></span>'+
									'</label>'+
									'<div class="star">'+
									'<a href="#"'+
									'<img'+
									'src="/img/svg/star.svg"'+
									'alt=""'+
									'class="svg"'+
									'/></a>'+
									'</div>'
						}
					},*/
					{
						"data": "toolDto.id",
						"type": Number
					},
					{"data": "toolDto.name"},
					{"data": "toolDto.engName"},
					{"data": "toolDto.code"},
					{
						"data": "toolDto.subGroupDto",
						"render": function (data, type, row) {
							if (type === "display") {
								return data.mainGroupDto.name;
							}
							return data;
						}
					},
					{
						"data": "toolDto.subGroupDto",
						"render": function (data, type, row) {
							if (type === "display") {
								return data.name;
							}
							return data;
						}
					},
					{"data": "toolDto.spec"},
					{"data": "toolDto.unit"},
					{"data": "toolDto.price", "type": Number},
					{"data": "toolDto.replacementCycle", "type": Number},
					{"data": "goodCount"}
				]
			});
			table.on('click', '.addRentalToolBtn', function () {
				var data = table.row($(this).parents('tr')).data();
				addTool.call(this, data.toolDto.id);
			});

			//검색
			$("#searchBtn").on("click", e => {
				e.preventDefault();
				table.draw();
			});
			
			//toolboxSelect동기화
			setTimeout(_=>{table.draw();},100);
		});
		document.getElementById("toolboxSelect").addEventListener("change",e=>{
			table.draw();
		});


	</script>
</th:block>

</html>